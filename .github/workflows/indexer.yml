name: Build Index

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  index:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Make index directory
      run: mkdir -p index

    - name: Generate index.json
      run: |
        echo "[" > index/index.json
        first=1
        for f in snapshots/*.tgz; do
          [ "$f" = "snapshots/*.tgz" ] && continue
          if [ $first -eq 0 ]; then echo "," >> index/index.json; fi
          first=0
          size=$(stat -c%s "$f")
          updated=$(date -r "$f" -u +"%Y-%m-%dT%H:%M:%SZ")
          base=$(basename "$f")
          echo "  {\"file\": \"$base\", \"size\": $size, \"updated\": \"$updated\"}" >> index/index.json
        done
        echo "]" >> index/index.json

    - name: Commit and Push
      run: |
        git config user.name "actions-user"
        git config user.email "actions@github.com"
        git add index/index.json || true
        git commit -m "Update index" || true
        git push || true
